name: Update Language Stats

on:
  schedule:
    - cron: "0 0 * * 1"   # weekly
  workflow_dispatch:

jobs:
  stats:
    runs-on: ubuntu-latest

    steps:
      - name: Get languages from all repos (public + private)
        uses: actions/github-script@v7
        id: stats
        with:
          github-token: ${{ secrets.ACCESS_TOKEN }}
          script: |
            const username = process.env.GITHUB_ACTOR;

            // List ALL repos (needs PAT)
            const repos = await github.paginate(
              github.rest.repos.listForAuthenticatedUser,
              { per_page: 100 }
            );

            const langs = {};

            for (const repo of repos) {
              const data = await github.rest.repos.listLanguages({
                owner: repo.owner.login,
                repo: repo.name
              });

              for (const [lang, val] of Object.entries(data.data)) {
                langs[lang] = (langs[lang] || 0) + val;
              }
            }

            return JSON.stringify(langs);

      - name: Save languages.json
        run: |
          echo '${{ steps.stats.outputs.result }}' > languages.json

      - name: Commit update
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add languages.json || true
          git commit -am "update languages" || true
          git push || true
