name: Update Language Stats

on:
  schedule:
    - cron: "0 0 * * 1"   # weekly
  workflow_dispatch:

permissions:
  contents: write

jobs:
  stats:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get languages from all repos (public + private)
        uses: actions/github-script@v7
        id: stats
        with:
          github-token: ${{ secrets.ACCESS_TOKEN || github.token }}
          script: |
            const fs = require("fs");
            const path = require("path");

            const user = await github.rest.users.getAuthenticated();
            const profile = user.data;

            const repos = await github.paginate(
              github.rest.repos.listForAuthenticatedUser,
              { per_page: 100, affiliation: "owner" }
            );

            const langs = {};
            let stars = 0;
            let forks = 0;
            let repoCount = 0;
            for (const repo of repos) {
              if (repo.fork || repo.archived) continue;
              repoCount += 1;
              stars += repo.stargazers_count || 0;
              forks += repo.forks_count || 0;

              const data = await github.rest.repos.listLanguages({
                owner: repo.owner.login,
                repo: repo.name
              });

              for (const [lang, val] of Object.entries(data.data)) {
                langs[lang] = (langs[lang] || 0) + val;
              }
            }

            const total = Object.values(langs).reduce((a, b) => a + b, 0) || 1;
            const top = Object.entries(langs)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 8)
              .map(([name, bytes]) => ({
                name,
                bytes,
                pct: (bytes / total) * 100
              }));

            const colors = {
              JavaScript: "#f1e05a",
              TypeScript: "#3178c6",
              Go: "#00ADD8",
              "C#": "#178600",
              Python: "#3572A5",
              "C++": "#f34b7d",
              Java: "#b07219",
              HTML: "#e34c26",
              CSS: "#563d7c",
              Shell: "#89e051"
            };

            const width = 800;
            const padding = 24;
            const barStartX = 210;
            const barWidth = 540;
            const barHeight = 14;
            const gap = 10;
            const headerH = 28;
            const height = padding * 2 + headerH + top.length * (barHeight + gap);

            let y = padding + headerH;
            let rows = "";
            for (const item of top) {
              const w = Math.max(6, Math.round((item.pct / 100) * barWidth));
              const color = colors[item.name] || "#6a737d";
              const labelY = y + barHeight - 2;
              rows += `
              <text x="24" y="${labelY}" font-size="12" fill="#c9d1d9">${item.name}</text>
              <text x="${barStartX + barWidth + 8}" y="${labelY}" font-size="12" fill="#c9d1d9">${item.pct.toFixed(1)}%</text>
              <rect x="${barStartX}" y="${y}" width="${barWidth}" height="${barHeight}" rx="7" fill="#161b22" />
              <rect x="${barStartX}" y="${y}" width="${w}" height="${barHeight}" rx="7" fill="${color}" />
              `;
              y += barHeight + gap;
            }

            const svg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
              <rect width="100%" height="100%" rx="12" fill="#0d1117" />
              <text x="24" y="36" font-size="16" font-weight="600" fill="#c9d1d9">Top Languages (all repos)</text>
              ${rows}
            </svg>
            `.trim();

            const statsWidth = 800;
            const statsHeight = 160;
            const stats = [
              ["Public Repos", repoCount],
              ["Stars", stars],
              ["Forks", forks],
              ["Followers", profile.followers || 0]
            ];
            const statBlockW = 180;
            const statBlockH = 64;
            const statGap = 20;
            const statStartX = 24;
            const statStartY = 64;

            let statRows = "";
            stats.forEach((s, i) => {
              const x = statStartX + i * (statBlockW + statGap);
              const y = statStartY;
              statRows += `
              <rect x="${x}" y="${y}" width="${statBlockW}" height="${statBlockH}" rx="10" fill="#161b22" />
              <text x="${x + 14}" y="${y + 24}" font-size="12" fill="#8b949e">${s[0]}</text>
              <text x="${x + 14}" y="${y + 50}" font-size="20" font-weight="600" fill="#c9d1d9">${s[1]}</text>
              `;
            });

            const statsSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="${statsWidth}" height="${statsHeight}" viewBox="0 0 ${statsWidth} ${statsHeight}">
              <rect width="100%" height="100%" rx="12" fill="#0d1117" />
              <text x="24" y="36" font-size="16" font-weight="600" fill="#c9d1d9">Profile Stats</text>
              ${statRows}
            </svg>
            `.trim();

            const outDir = path.join(process.cwd(), "assets");
            fs.mkdirSync(outDir, { recursive: true });
            fs.writeFileSync("languages.json", JSON.stringify(langs, null, 2));
            fs.writeFileSync(path.join(outDir, "languages.svg"), svg);
            fs.writeFileSync(path.join(outDir, "stats.svg"), statsSvg);

            return JSON.stringify(langs);

      - name: Commit update
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add languages.json assets/languages.svg assets/stats.svg || true
          git commit -am "update languages" || true
          git push || true
