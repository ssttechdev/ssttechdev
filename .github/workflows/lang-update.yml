name: Update Language Stats

on:
  schedule:
    - cron: "0 0 * * 1"     # every Monday
  workflow_dispatch:

permissions:
  contents: read
  metadata: read

jobs:
  stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        id: stats
        with:
          script: |
            const username = process.env.GITHUB_ACTOR;

            // fetch all repos including private
            const repos = await github.paginate(
              github.rest.repos.listForUser,
              { username, per_page: 100 }
            );

            const langs = {};

            for (const repo of repos) {
              const langData = await github.rest.repos.listLanguages({
                owner: username,
                repo: repo.name
              });

              for (const [lang, val] of Object.entries(langData.data)) {
                langs[lang] = (langs[lang] || 0) + val;
              }
            }

            return JSON.stringify(langs);

      - name: Save languages.json
        run: |
          echo '${{ steps.stats.outputs.result }}' > languages.json

      - name: Commit update
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add languages.json || true
          git commit -am "update languages" || true
          git push || true
